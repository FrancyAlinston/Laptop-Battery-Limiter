#!/usr/bin/env python3

import gi
gi.require_version('Gtk', '3.0')
gi.require_version('AppIndicator3', '0.1')
gi.require_version('Notify', '0.7')

from gi.repository import Gtk, AppIndicator3, GObject, Notify
import subprocess
import threading
import time
import os

class BatteryLimitIndicator:
    def __init__(self):
        # Initialize notification
        Notify.init("Battery Limiter")
        
        # Create indicator
        self.indicator = AppIndicator3.Indicator.new(
            "battery-limiter",
            "battery",
            AppIndicator3.IndicatorCategory.HARDWARE
        )
        
        self.indicator.set_status(AppIndicator3.IndicatorStatus.ACTIVE)
        self.indicator.set_menu(self.create_menu())
        
        # Battery files
        self.threshold_file = "/sys/class/power_supply/BAT0/charge_control_end_threshold"
        self.capacity_file = "/sys/class/power_supply/BAT0/capacity"
        self.status_file = "/sys/class/power_supply/BAT0/status"
        
        # Update indicator
        self.update_indicator()
        
        # Start update thread
        self.start_update_thread()

    def create_menu(self):
        menu = Gtk.Menu()
        
        # Battery status item
        self.status_item = Gtk.MenuItem()
        self.status_item.set_sensitive(False)
        menu.append(self.status_item)
        
        # Separator
        separator = Gtk.SeparatorMenuItem()
        menu.append(separator)
        
        # Quick presets
        presets = [
            ("🔋 60% (Storage)", 60),
            ("🔋 70% (Conservative)", 70),
            ("🔋 80% (Recommended)", 80),
            ("🔋 90% (Extended)", 90),
            ("🔋 100% (Full)", 100)
        ]
        
        for label, value in presets:
            item = Gtk.MenuItem(label=label)
            item.connect("activate", self.set_limit, value)
            menu.append(item)
        
        # Separator
        separator2 = Gtk.SeparatorMenuItem()
        menu.append(separator2)
        
        # Advanced options
        advanced_item = Gtk.MenuItem(label="🔧 Advanced Settings")
        advanced_item.connect("activate", self.open_gui)
        menu.append(advanced_item)
        
        cli_item = Gtk.MenuItem(label="📟 Open CLI")
        cli_item.connect("activate", self.open_cli)
        menu.append(cli_item)
        
        # Separator
        separator3 = Gtk.SeparatorMenuItem()
        menu.append(separator3)
        
        # Refresh
        refresh_item = Gtk.MenuItem(label="🔄 Refresh")
        refresh_item.connect("activate", self.refresh)
        menu.append(refresh_item)
        
        # About
        about_item = Gtk.MenuItem(label="ℹ️ About")
        about_item.connect("activate", self.show_about)
        menu.append(about_item)
        
        # Exit
        exit_item = Gtk.MenuItem(label="❌ Exit")
        exit_item.connect("activate", self.quit)
        menu.append(exit_item)
        
        menu.show_all()
        return menu

    def get_battery_info(self):
        try:
            limit = self.read_file(self.threshold_file, "N/A")
            level = self.read_file(self.capacity_file, "N/A")
            status = self.read_file(self.status_file, "N/A")
            return limit, level, status
        except:
            return "N/A", "N/A", "N/A"

    def read_file(self, filepath, default="N/A"):
        try:
            with open(filepath, 'r') as f:
                return f.read().strip()
        except:
            return default

    def update_indicator(self):
        limit, level, status = self.get_battery_info()
        
        # Update status item
        status_text = f"🔋 {level}% ({status}) | Limit: {limit}%"
        self.status_item.set_label(status_text)
        
        # Update tooltip
        self.indicator.set_title(f"Battery: {level}% | Limit: {limit}%")

    def set_limit(self, widget, limit):
        def run_command():
            try:
                # Use pkexec for GUI authentication
                cmd = f"pkexec bash -c 'echo {limit} > {self.threshold_file}'"
                result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
                
                if result.returncode == 0:
                    GObject.idle_add(self.show_notification, 
                                   "Battery Limit Set", 
                                   f"Charging limit set to {limit}%")
                    GObject.idle_add(self.update_indicator)
                else:
                    GObject.idle_add(self.show_notification, 
                                   "Error", 
                                   "Failed to set battery limit")
            except Exception as e:
                GObject.idle_add(self.show_notification, 
                               "Error", 
                               f"Failed to set battery limit: {str(e)}")
        
        # Run in thread to avoid blocking UI
        thread = threading.Thread(target=run_command)
        thread.daemon = True
        thread.start()

    def show_notification(self, title, message):
        notification = Notify.Notification.new(title, message, "battery")
        notification.show()

    def open_gui(self, widget):
        script_dir = os.path.dirname(os.path.abspath(__file__))
        gui_path = os.path.join(script_dir, "battery-gui")
        subprocess.Popen(["python3", gui_path])

    def open_cli(self, widget):
        script_dir = os.path.dirname(os.path.abspath(__file__))
        cli_path = os.path.join(script_dir, "battery-cli")
        subprocess.Popen(["gnome-terminal", "--", "sudo", cli_path])

    def refresh(self, widget):
        self.update_indicator()
        self.show_notification("Refreshed", "Battery information updated")

    def show_about(self, widget):
        dialog = Gtk.AboutDialog()
        dialog.set_name("ASUS Battery Limiter")
        dialog.set_version("1.0")
        dialog.set_comments("Battery charge limit management for ASUS laptops")
        dialog.set_website("https://github.com/yourusername/Battery-Limiter")
        dialog.set_authors(["Your Name"])
        dialog.set_license_type(Gtk.License.MIT_X11)
        dialog.run()
        dialog.destroy()

    def start_update_thread(self):
        def update_loop():
            while True:
                time.sleep(30)  # Update every 30 seconds
                GObject.idle_add(self.update_indicator)
        
        thread = threading.Thread(target=update_loop)
        thread.daemon = True
        thread.start()

    def quit(self, widget):
        Notify.uninit()
        Gtk.main_quit()

def main():
    indicator = BatteryLimitIndicator()
    Gtk.main()

if __name__ == "__main__":
    main()
